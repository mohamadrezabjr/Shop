{% load static %}
{% load humanize %}

<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لیست علاقه‌مندی‌ها</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link rel="stylesheet" href="{% static 'css/products.css' %}">
    <link rel="stylesheet" href="{% static 'css/wishlist.css' %}">
    <script src="{% static 'js/wishlist.js' %}" defer></script>
    <script src="{% static 'js/products.js' %}" defer></script>
    <script src="{% static 'js/script.js' %}" defer></script>


</head>
<body>
{% include 'partials/header.html' %}
    <div class="breadcrumb">
        <div class="container">
            <nav class="breadcrumb-nav">
                <a href="{% url 'index' %}">خانه</a>
                <span>/</span>
                <span>لیست علاقه‌مندی‌ها</span>
            </nav>
        </div>
    </div>

    <section class="products-page">
        <div class="container">
            <div class="products-layout">
                <!-- Sidebar Filters -->
                <aside class="filters-sidebar">
                    <div class="filters-header">
                        <h3>فیلتر محصولات</h3>
                        <button class="clear-filters" onclick="clearAllFilters()">پاک کردن همه</button>
                    </div>

                    <form method="GET" action="{% url 'wishlist' %}" id="filtersForm">
                        <!-- Search Filter -->
                        <div class="filter-group">
                            <h4>جستجو در {{ category.name }}</h4>
                            <input type="text" name="search" placeholder="نام محصول..." value="{{ request.GET.search }}">
                        </div>

                        <!-- Subcategory Filter -->
                        {% if subcategories %}
                        <div class="filter-group">
                            <h4>زیردسته‌ها</h4>
                            <div class="filter-options">
                                {% for subcategory in subcategories %}
                                <label class="filter-option">
                                    <input type="checkbox" name="subcategory" value="{{ subcategory.id }}"
                                           {% if subcategory.id|stringformat:"s" in selected_subcategories %}checked{% endif %}>
                                    <span>{{ subcategory.name }}</span>
                                    <small>({{ subcategory.product_count }})</small>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Price Range Filter -->
                        <div class="filter-group">
                            <h4>محدوده قیمت</h4>
                            <div class="price-range">
                                <input type="number" name="min_price" placeholder="حداقل قیمت" value="{{ request.GET.min_price }}">
                                <span>تا</span>
                                <input type="number" name="max_price" placeholder="حداکثر قیمت" value="{{ request.GET.max_price }}">
                            </div>
                            <div class="price-suggestions">
                                <button type="button" onclick="setPriceRange(0, 1000000)">زیر 1 میلیون</button>
                                <button type="button" onclick="setPriceRange(1000000, 10000000)">1 تا 10 میلیون</button>
                                <button type="button" onclick="setPriceRange(10000000, 20000000)">10 میلیون تا 20 میلیون</button>
                                <button type="button" onclick="setPriceRange(20000000, 50000000)">20 میلیون تا 50 میلیون</button>
                                <button type="button" onclick="setPriceRange(50000000, 100000000)">50 میلیون تا 100 میلیون</button>
                                <button type="button" onclick="setPriceRange(100000000, 0)">بالای 100 میلیون</button>

                            </div>
                        </div>

                        <!-- Brand Filter (if applicable) -->
                        {% if brands %}
                        <div class="filter-group">
                            <h4>برند</h4>
                            <div class="filter-options">
                                {% for brand in brands %}
                                <label class="filter-option">
                                    <input type="checkbox" name="brand" value="{{ brand.id }}"
                                           {% if brand.id|stringformat:"s" in selected_brands %}checked{% endif %}>
                                    <span>{{ brand.name }}</span>
                                    <small>({{ brand.product_count }})</small>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Discount Filter -->
                        <div class="filter-group">
                            <h4>تخفیف‌دار</h4>
                            <label class="filter-option">
                                <input type="checkbox" name="has_discount" value="1"
                                       {% if request.GET.has_discount %}checked{% endif %}>
                                <span>فقط محصولات تخفیف‌دار</span>
                            </label>
                        </div>

                        <!-- Rating Filter -->
                        <div class="filter-group">
                            <h4>امتیاز</h4>
                            <div class="rating-filters">
                                {% for rating in "54321" %}
                                <label class="filter-option">
                                    <input type="radio" name="min_rating" value="{{ rating }}"
                                           {% if request.GET.min_rating == rating %}checked{% endif %}>
                                    <span class="stars">
                                        {% for i in "12345" %}
                                            {% if forloop.counter <= rating|add:0 %}★{% else %}☆{% endif %}
                                        {% endfor %}
                                    </span>
                                    <span>و بالاتر</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Availability Filter -->
                        <div class="filter-group">
                            <h4>موجودی</h4>
                            <label class="filter-option">
                                <input type="checkbox" name="in_stock" value="1"
                                       {% if request.GET.in_stock %}checked{% endif %}>
                                <span>فقط کالاهای موجود</span>
                            </label>
                        </div>

                        <button type="submit" class="apply-filters">اعمال فیلترها</button>
                    </form>
                </aside>
                <!-- Products Main -->
                <main class="products-main">
                    <div class="products-header">
                        <div class="products-info">
                            <h1>لیست علاقه‌مندی‌ها</h1>
                            <p>{{ wishlist_products.count }} محصول در علاقه‌مندی‌ها</p>
                        </div>
                        <div class="products-controls">
                            <!-- View Toggle -->
                            <div class="view-toggle">
                                <button class="view-btn active" data-view="grid" title="نمایش شبکه‌ای">
                                    <i class="fas fa-th"></i>
                                </button>
                                <button class="view-btn" data-view="list" title="نمایش لیستی">
                                    <i class="fas fa-list"></i>
                                </button>
                            </div>

                            <!-- Sort Options -->
                            <select name="sort" onchange="sortProducts(this.value)" class="sort-select">
                                <option value="">مرتب‌سازی بر اساس</option>
                                <option value="newest" {% if request.GET.sort == 'newest' %}selected{% endif %}>جدیدترین</option>
                                <option value="oldest" {% if request.GET.sort == 'oldest' %}selected{% endif %}>قدیمی‌ترین</option>
                                <option value="price_low" {% if request.GET.sort == 'price_low' %}selected{% endif %}>ارزان‌ترین</option>
                                <option value="price_high" {% if request.GET.sort == 'price_high' %}selected{% endif %}>گران‌ترین</option>
                                <option value="rating" {% if request.GET.sort == 'rating' %}selected{% endif %}>بهترین امتیاز</option>
                                <option value="popular" {% if request.GET.sort == 'popular' %}selected{% endif %}>محبوب‌ترین</option>
                            </select>

                            <!-- Mobile Filter Toggle -->
                            <button class="mobile-filter-toggle" onclick="toggleMobileFilters()">
                                <i class="fas fa-filter"></i>
                                فیلترها
                            </button>
                        </div>
                    </div>
                    {% if active_filters %}
                        <div class="active-filters">
                            فیلترهای فعال:
                            {% for filter in active_filters %}
                                <span class="active-filter">{{ filter.name }} ×</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="products-container" id="productsContainer">
                        {% if wishlist_products %}
                        <div class="products-grid" id="productsGrid">
                            {% for product in wishlist_products %}
                            <div class="product-card fade-in">
                                <!-- نشان تخفیف -->
                                {% if product.discount != 0%}
                                    <div class="discount-badge">
                                        {{ product.discount }}% تخفیف
                                    </div>
                                {% endif %}

                                <a href="{% url 'detail' product.token %}" class="product-link">
                                    {% if product.image %}
                                    <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-image">
                                    {% endif %}
                                </a>

                                <div class="product-info">
                                    <h3 class="product-title">
                                        <a href="{% url 'detail' product.token %}" style="text-decoration: none;">
                                            {{ product.name }}
                                        </a>
                                    </h3>

                                    <div class="product-category">
                                        <a href="{% url 'category_products' product.category.name %}">
                                            {{ product.category.name }}
                                        </a>
                                    </div>

                    <!-- Stock Status -->
                    <div class="stock-status">
                        {% if product.stock > 0 %}
                            <span class="in-stock">
                                <i class="fas fa-check-circle" style="color: #00b348"></i>
                                موجود در انبار ({{ product.stock }} عدد)
                            </span>
                        {% else %}
                            <span class="out-of-stock" style="color: red">
                                <i class="fas fa-times-circle" style="color: red"></i>
                                ناموجود
                            </span>
                        {% endif %}
                    </div>

                                    <!-- قیمت با تخفیف -->
                                    <div class="product-pricing">
                                        {% if product.discount != 0 %}
                                            <div class="price-with-discount">
                                                <span class="current-price">{{ product.sale_price|intcomma }} تومان </span>
                                                <span class="original-price">{{ product.price|intcomma }}</span>
                                            </div>
{#                                            <div class="discount-amount">#}
{#                                                صرفه‌جویی {{ product.discount_amount|price_format }} تومان#}
{#                                            </div>#}
                                        {% else %}
                                            <div class="product-price">{{ product.price|intcomma }} تومان </div>
                                        {% endif %}
                                    </div>

                                    <div class="product-rating">
                                        <span class="stars">
                                            {% for i in "12345" %}
                                                {% if forloop.counter <= product.rating %}★{% else %}☆{% endif %}
                                            {% endfor %}
                                        </span>
                                        <span class="rating-text">({{ product.rating }})</span>
                                    </div>

                                    <div class="product-actions">
                                        <!-- فرم افزودن به سبد خرید -->
                                        <form method="POST" action="{% url 'add_to_cart' token=product.token %}" class="add-to-cart-form">
                                            {% csrf_token %}
                                            <button type="submit" class="add-to-cart-btn">
                                                <i class="fas fa-shopping-cart"></i>
                                                {% if product.discount != 0 %}
                                                    خرید با تخفیف
                                                {% else %}
                                                    افزودن به سبد
                                                {% endif %}
                                            </button>
                                        </form>

                                        <button class="remove-from-wishlist" onclick="removeWishlist({{ product.id }}, event)">
                                            <i class="fas fa-trash"></i>
                                            </button>

                                        <a href="{% url 'detail' product.token %}" class="quick-view-btn">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                            {% if empty %}
                            <div class="no-products">
                                <i class="fas fa-heart-broken no-products-icon"></i>

                                <h3>لیست علاقه‌مندی‌ها خالی است</h3>
                                <p>محصولی به لیست علاقه‌مندی‌ها اضافه نشده است.</p>
                                <a href = '{% url "products" %}' style="text-decoration: none; ">
                                    <button class="clear-filters-btn">رفتن به لیست محصولات</button>
                                </a>
                            </div>
                            {% else %}
                        <div class="no-products">
                            <div class="no-products-icon">
                            </div>
                            <div class="no-products-icon">
                                <i class="fas fa-search"></i>
                            </div>
                            <h3>محصولی یافت نشد</h3>
                            <p>متأسفانه محصولی با این مشخصات در پیدا نکردیم.</p>
                            <button onclick="clearAllFilters()" class="clear-filters-btn">پاک کردن فیلترها</button>
                        </div>
                                {% endif %}
                        {% endif %}
                    </div>
                    {% if wishlist_products.has_other_pages %}
                        <div class="pagination-container">
                            <nav class="pagination">
                                {% if wishlist_products.has_previous %}
                                    <a href="?page=1" class="page-btn">&laquo;</a>
                                {% endif %}
                                {% for num in wishlist_products.paginator.page_range %}
                                    {% if wishlist_products.number == num %}
                                        <span class="page-btn active">{{ num }}</span>
                                    {% elif num > wishlist_products.number|add:'-3' and num < wishlist_products.number|add:'3' %}
                                        <a href="?page={{ num }}" class="page-btn">{{ num }}</a>
                                    {% endif %}
                                {% endfor %}
                                {% if wishlist_products.has_next %}
                                    <a href="?page={{ wishlist_products.paginator.num_pages }}" class="page-btn">&raquo;</a>
                                {% endif %}
                            </nav>
                            <p class="pagination-info">
                                صفحه {{ wishlist_products.number }} از {{ wishlist_products.paginator.num_pages }}
                                ({{ wishlist_products.paginator.count }} محصول)
                            </p>
                        </div>
                    {% endif %}
                </main>
            </div>
        </div>
    </section>
{% include 'partials/footer.html' %}
    <script src="{% static 'js/wishlist.js' %}"></script>
    <script src="{% static 'js/products.js' %}" ></script>
    <script src="{% static 'js/script.js' %}" ></script>
</body>
</html>